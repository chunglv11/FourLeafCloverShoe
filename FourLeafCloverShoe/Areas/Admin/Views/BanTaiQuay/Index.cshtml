@{
    Layout = "~/Areas/Admin/Shared/_LayoutBanTaiQuay.cshtml";
}
<style>
    .dropdown-menu {
        max-height: 500px;
        overflow-y: auto;
    }

    #searchResults {
        width: 100%;
    }

    .product-item {
        display: flex;
        align-items: center;
    }

    .product-image {
        width: 30px;
        height: 30px;
        margin-right: 10px;
        border-radius: 50%;
    }

    .tabs {
        display: flex;
        align-items: center;
    }

    .tab {
        background-color: transparent;
        border: none;
        border-radius: solid 1px;
        cursor: pointer;
        outline: none;
        padding: 10px 20px;
        margin-right: 10px;
        position: relative;
        transition: background-color 0.3s;
    }

        .tab:hover {
            background-color: #f0f0f0;
        }

        .tab.active {
            border-bottom: 2px solid blue;
            background-color: #04A9F5;
            color: white;
        }

    .tab-close {
        margin-left: 5px;
        cursor: pointer;
    }

        .tab-close:hover {
            color: red;
        }

    .tab-add {
        margin-right: 5px;
    }

    .tabs {
        display: flex;
        align-items: center;
        overflow-x: auto; /* Thêm thanh cuộn ngang */
        white-space: nowrap; /* Ngăn chặn các tab từ việc chuyển xuống dòng tiếp theo */
    }

</style>


<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModal" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title h4" id="exampleModalFullscreenLabel">Thanh toán đơn hàng </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"> </button>
            </div>
            <div class="modal-body">
                <iframe id="paymentUrl" src=""
                        width="100%" height="100%"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="registerModalLabel">Đăng kí khách hàng mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="fullName" class="form-label">Họ và tên</label>
                        <input type="text" class="form-control" id="fullName1" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label">Số điện thoại</label>
                        <input type="tel" class="form-control" id="phoneNumber1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="register">Đăng kí</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cameraModalLabel">Chọn camera</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <select id="cameraSelect" class="form-select"></select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="applyCamera">Áp dụng</button>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-6">
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="searchInput" placeholder="Nhập tên sản phẩm..." autocomplete="off">
            <button class="btn btn-outline-success">
                <span title="Tìm kiếm bằng QR Code" style="float:left">
                    <a href="javascript:;" id="start" class="count-holder">
                        <img src="~/fileuser/Assets/App/images/searchqr.png" width="25" />
                    </a>
                </span>
            </button>

        </div>
        <div class="dropdown">
            <ul class="dropdown-menu" id="searchResults" aria-labelledby="dropdownMenuButton">
            </ul>
        </div>
    </div>
    <div class=" col-md-6 ">
        <div class="row ">
            <div class="col">
                <div class="tabs">
                    <!-- Dấu + để tạo tab mới -->
                    <button class="tab tab-add"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="row">
    <!-- [ sample-page ] start -->
    <div class="col-sm-12">
        <div>
        </div>
        <div class="tab-content">
            <div class="tab-pane show active" id="ecomtab-1" role="tabpanel" aria-labelledby="ecomtab-tab-1">
                <div class="row">
                    <div class="col-xl-8 card">
                        <div class="card">
                            <div class="card-body p-0 table-body">
                                <div class="table-responsive">
                                    <table class="table mb-0" id="pc-dt-simple">
                                        <thead>
                                            <tr>
                                                <th style="text-align: center;">Sản phẩm</th>
                                                <th style="text-align: center;">Đơn giá</th>
                                                <th style="text-align: center;">Số lượng</th>
                                                <th style="text-align: center;">Tổng tiền</th>
                                                <th style="text-align: center;">#</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-xl-4">
                        <div class="form-group row">
                            <div class="col-lg-10">
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="searchNumberPhone" placeholder="Nhập số điện thoại..." autocomplete="off">
                                </div>
                                <div class="dropdown">
                                    <ul class="dropdown-menu form-control" id="searchNumberPhoneResults" aria-labelledby="dropdownMenuButton">
                                    </ul>
                                </div>
                            </div>
                            <div class="col-lg-2">
                                <a href="#" style="margin-top:15px;" id="themKhachHang" title="Thêm khách hàng mới" class="avtar avtar-xs btn-link-danger btn-pc-default">
                                    <i style="font-size:25px;" class="fas fa-user-plus">

                                    </i>
                                </a>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body py-2">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item px-0">
                                        <div class="float-end">
                                            <h5 class="mb-0" id="fullName"> Khách vãng lai</h5>
                                        </div><span class="text-muted">Khách hàng : </span>
                                    </li>
                                    <li class="list-group-item px-0">
                                        <div class="float-end">
                                            <h5 class="mb-0" id="phoneNumber"> - </h5>
                                        </div><span class="text-muted">SĐT : </span>
                                    </li>

                                </ul>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body py-2">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item px-0">
                                        <div class="float-end">
                                            <h5 class="mb-0" id="total"></h5>
                                        </div><span class="text-muted">Tổng tiền  <input type="number" hidden id="productQuantity" /></span>
                                    </li>
                                    <li class="list-group-item px-0">
                                        <span class="text-muted">Mã giảm giá </span>
                                        <div class="float-end">
                                            <select id="discount-select" class="form-control shadow-none border-1">
                                            </select>
                                        </div>
                                    </li>
                                    <li class="list-group-item px-0">
                                        <div class="float-end">
                                            <input type="number" value="0" min="0" id="coinsUsed" class="form-control shadow-none border-1" style="text-align:right" />
                                        </div><span class="text-muted">Xu sử dụng <br /> (<span id="coins">0</span>)</span>
                                    </li>
                                    <li class="list-group-item px-0">
                                        <div>
                                            <div class="float-end">
                                                - <span class="text-muted" id="spanGiamGia">0 đ </span>
                                            </div><span class="text-muted">Giảm Voucher </span>
                                        </div>
                                        <div>
                                            <div class="float-end">
                                                - <span class="text-muted" id="spanGiamGiaCoins"> 0 đ </span>
                                            </div><span class="text-muted">Giảm xu </span>
                                        </div>
                                        <div>
                                            <div class="float-end">
                                                + <span class="text-muted" id="xuTichDuoc"> 0 xu </span>
                                            </div><span class="text-muted">Xu tích được:  </span>
                                        </div>

                                        <div>
                                            <div class="float-end">
                                                <h5 class="mb-0" id="totalAmount"></h5>
                                            </div>
                                            <h5 class="mb-0 d-inline-block">Khách phải trả</h5>
                                        </div>

                                    </li>


                                    <li class="list-group-item px-0">
                                        <div>
                                            <div class="float-end">
                                                <input type="number" value="0" min="0" id="moneyGiven" class="form-control shadow-none border-1" style="text-align:right" />
                                            </div><span class="text-muted">Tiền khách đưa: </span>
                                        </div>
                                        <div>
                                            <div>
                                                <select id="paymentType" class="shadow-none border-0">
                                                    <option value="off" selected>Tiền mặt</option>
                                                    <option value="momo">Momo QR</option>
                                                    <option value="vnpay">VNPay</option>
                                                </select>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="list-group-item px-0">
                                        <div class="float-end">
                                            <h5 class="mb-0">0 đ</h5>
                                        </div><h5 class="mb-0 d-inline-block">Tiền thừa trả khách: </h5>
                                    </li>

                                </ul>
                                <hr />
                                <div class="d-grid mb-3 row">
                                    <div>
                                        <button class="btn btn-outline-danger"  id="huyDon">Huỷ đơn</button>
                                        <button class="btn btn-primary col-md-7 float-end" id="checkOut">Thanh toán</button>
                                    </div>


                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>


        </div>
    </div>
    <!-- [ sample-page ] end -->
</div>
<input type="text" id="orderIdInput" hidden />
<video id="video" width="300" height="200" autoplay hidden></video>

<!-- [ Main Content ] end -->
<script src="~/fileadmin/assets/js/plugins/choices.min.js"></script>
<script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


<script>
    let tabs = [];
    let lastTab;
    let totalAmount = 0;
    let coinUsed = 0;
    let myCoins = 0;
    let voucherValue = 0;
    let voucherId = "";
    let total = 0;
    $(document).ready(function () {
        $.ajax({
            url: '/Admin/BanTaiQuay/GetPendingOrders',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                data.forEach(function (orderId) {
                    const newTabIndex = tabs.length ? Math.max(...tabs) + 1 : 1;
                    tabs.push(newTabIndex);
                    const newTab = $('<button></button>').addClass('tab').text('Đơn ' + newTabIndex);
                    newTab.append('<span class="tab-close"><i class="fas fa-times-circle"></i></span>');
                    newTab.data('orderId', orderId);
                    $(newTab).insertBefore('.tab-add');
                    setActiveTab(newTab);
                    lastTab = newTab;
                    $('.tabs').scrollLeft($('.tabs')[0].scrollWidth);
                });
                // Nếu có tab, gán và click vào tab đầu tiên
                if (tabs.length > 0) {
                    const firstTab = $('.tab:not(.tab-add)').first();
                    setActiveTab(firstTab);
                    $("#orderIdInput").val(firstTab.data('orderId'));
                    loadDataUserOrder($("#orderIdInput").val());
                    updateTable();
                }
            },
            error: function (error) {
                console.log(error);
            }
        });
        if (tabs.length === 0) { // tự động click vào tạo tab mới nếu chưa có đơn nào
            $('.tab-add').click();
            // Gán orderId của tab mới vào #orderIdInput
            $("#orderIdInput").val($('.tab.active').data('orderId'));
            updateTable();
        }
        // Gắn sự kiện cho input search
        $('#searchInput').on('input', function (event) {
            var searchTerm = event.target.value;
            search(searchTerm);
        });
        // Gắn sự kiện cho input search
        $('#searchNumberPhone').on('input', function (event) {
            var searchTerm = event.target.value;
            searchNumberPhone(searchTerm);
        });
        connection.on("ReceiveNotification", (message, status) => {
            showToast(message, status);
            var orderId = $("#orderIdInput").val();
            $.ajax({
                url: '/order/ExportPDF',
                type: 'GET',
                data: {
                    orderId: orderId,

                },
                success: function (result) {

                }
            });

            loadDataUserOrder($("#orderIdInput").val());
        });
        $('#checkOut').on('click', function () {
            if (totalAmount > $("#moneyGiven").val()) {
                showToast("Vui lòng nhập số tiền khách trả!", false);
            } else {
                var paymentType = $("#paymentType").val();
                var orderId = $("#orderIdInput").val();
                var voucherId = $("#discount-select").val();
                $.ajax({
                    url: '/Admin/BanTaiQuay/CheckOut',
                    type: 'POST',
                    data: {
                        orderId: orderId,
                        coinUsed: coinUsed,
                        voucherValue: voucherValue,
                        voucherId: voucherId,
                        paymentType: paymentType
                    },
                    success: function (result) {
                        if (result.isSuccess) {
                            if (result.paymentType == "off") {
                                showToast(result.message, result.isSuccess);
                                $.ajax({
                                    url: '/order/ExportPDF',
                                    type: 'GET',
                                    data: {
                                        orderId: orderId,

                                    },
                                    success: function (result) {

                                    }
                                });
                                loadDataUserOrder($("#orderIdInput").val());
                            }
                            else {
                                window.open(result.url, '_blank');
                            }
                        } else {
                            showToast(result.message, false);
                        }
                    },
                    error: function (error) {
                        showToast("Có lỗi xảy ra, vui lòng thử lại!", false);
                    }
                });
            }
        });
        $('#huyDon').on('click', function () {
            var orderId = $("#orderIdInput").val();
            $.ajax({
                url: '/Admin/BanTaiQuay/huyDon',
                type: 'POST',
                data: {
                    orderId: orderId,
                },
                success: function (result) {
                    loadDataUserOrder($("#orderIdInput").val());
                    showToast(result.message, result.isSuccess);
                },
                error: function (error) {
                    showToast("Có lỗi xảy ra, vui lòng thử lại!", false);
                }
            });
        });
        $('#themKhachHang').on('click', function () {
            $("#registerModal").modal('show');
        });
        $('#register').click(function (e) {
            var isValid = true;
            $('#fullName1, #email, #phoneNumber1, #password').each(function () {
                if ($.trim($(this).val()) == '') {
                    isValid = false;
                    $(this).css({
                        "border": "1px solid #FF0000",
                        "background": "#FFCECE"
                    });
                }
                else {
                    $(this).css({
                        "border": "",
                        "background": ""
                    });
                }
            });

            // Xác thực số điện thoại
            var phoneNumber = $('#phoneNumber1').val();
            var phonePattern = /^0\d{9}$/; // Bắt đầu bằng số 0 và có tổng cộng 10 chữ số

            // Xác thực email
            var email = $('#email').val();
            var emailPattern = /^[a-zA-Z0-9._%+-]+@@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/; // Định dạng email thông thường
            var fullName = $('#fullName1').val();
            if (fullName.length <= 10) {
                isValid = false;
                alert('Họ và tên phải có nhiều hơn 10 ký tự.');
            }
            else if (!phonePattern.test(phoneNumber)) {
                isValid = false;
                alert('Số điện thoại phải bắt đầu bằng số 0 và có tổng cộng 10 chữ số.');
            }

            else if (!emailPattern.test(email)) {
                isValid = false;
                alert('Email không hợp lệ.');
            }
            else {
                isValid = true;
            }

            if (isValid == false)
                e.preventDefault();
            else {
                $("#registerModal").modal('hide');
                $.ajax({
                    url: '/Admin/BanTaiQuay/Register',
                    type: 'POST',
                    data: {
                        fullName: fullName,
                        email: email,
                        phoneNumber: phoneNumber
                    },
                    success: function (results) {
                        showToast(results.message, results.isSuccess);
                    },
                    error: function (error) {
                        showToast("Có lỗi xảy ra, vui lòng thử lại!", false);
                    }
                });
            }
        });


        $('.tab-add').click(function () {
            const newTabIndex = tabs.length ? Math.max(...tabs) + 1 : 1;
            tabs.push(newTabIndex);
            const newTab = $('<button></button>').addClass('tab').text('Đơn ' + newTabIndex);
            newTab.append('<span class="tab-close"><i class="fas fa-times-circle"></i></span>');

            $.ajax({
                url: '/Admin/BanTaiQuay/CreateNewOrder',
                type: 'GET',
                dataType: 'json',
                success: function (data) { // Hàm này sẽ được gọi khi yêu cầu thành công
                    newTab.data('orderId', data.orderId); // lưu dữ liệu  data.orderId với tên orderId vào newtab
                    $("#orderIdInput").val(newTab.data('orderId')); // gán id vào orderIdInput
                    loadDataUserOrder($("#orderIdInput").val());
                    updateTable();
                },
                error: function (error) {
                    console.log(error);
                }
            });
            $(newTab).insertBefore('.tab-add');
            setActiveTab(newTab); // Kích hoạt tab mới
            lastTab = newTab;
            $('.tabs').scrollLeft($('.tabs')[0].scrollWidth);
        });

        $(document).on('click', '.tab:not(.tab-add)', function () {
            setActiveTab($(this));
            $("#orderIdInput").val($(this).data('orderId')); // gán id vào orderIdInput
            loadDataUserOrder($("#orderIdInput").val());
            updateTable();
        });


        $(document).on('change', '#discount-select', function () {
            var voucherId = $(this).val();
            totalAmount = total - coinUsed; // reset totalAmount to original total minus coins used before applying new voucher
            $.ajax({
                type: "POST",
                url: "/Admin/BanTaiQuay/ApplyVoucher",
                data: {
                    voucherId: voucherId
                },
                success: function (result) {
                    if (result.isSuccess) {
                        if (totalAmount == 0) {
                            $("#discount-select").prop("selectedIndex", 0);
                            $("#spanGiamGia").text(VoucherValue.toLocaleString('en-US', { minimumFractionDigits: 0 }) + " đ");
                            showToast("Không thể áp dụng voucher do đơn hàng đang là 0đ!", false);
                        }
                        else {
                            if (result.voucherType == 1) { // theo %
                                var tinhtien = result.voucherValue * total / 100;
                                voucherValue = tinhtien;
                                if (tinhtien > result.maxDiscount) {
                                    voucherValue = result.maxDiscount;
                                }
                                if (tinhtien > totalAmount) {
                                    voucherValue = totalAmount;
                                }
                            }
                            else {// theo vnd
                                voucherValue = result.voucherValue;
                                if (result.voucherValue > totalAmount) {
                                    voucherValue = totalAmount;
                                }
                            }
                            totalAmount -= voucherValue;
                            $("#spanGiamGia").text(voucherValue.toLocaleString('en-US', { minimumFractionDigits: 0 }) + " đ");
                            $("#totalAmount").text(totalAmount.toLocaleString('en-US', { minimumFractionDigits: 0 }) + " đ");
                            voucherId = result.id;
                            showToast("Đã áp dụng voucher", true);
                        }
                    } else {
                        voucherId = "";
                        voucherValue = 0;
                        $("#spanGiamGia").text(voucherValue.toLocaleString('en-US', { minimumFractionDigits: 0 }) + " đ");
                        $("#totalAmount").text(totalAmount.toLocaleString('en-US', { minimumFractionDigits: 0 }) + " đ");
                        showToast("Không thể áp dụng voucher", false);
                    }
                },
                error: function (error) {
                    console.log(error);
                }
            });
        });

        $(document).on('change', '#coinsUsed', function () {
            myCoins += coinUsed || 0; // return the coins used in the previous input
            totalAmount = total - voucherValue; // reset totalAmount to original total minus voucher used before applying new coins
            coinUsed = parseInt($(this).val()); // Số coins mà người dụng muốn sử dụng

            if (isNaN(coinUsed) || coinUsed < 0) {
                showToast("Số xu bạn nhập không hợp lệ!", false);
                $("#coinsUsed").val(0); // reset the input field to 0
                coinUsed = 0;
                return;
            }
            if (coinUsed > myCoins) {
                showToast("Bạn không thể sử dụng nhiều hơn số coins bạn có!", false);
                $("#coinsUsed").val(0); // reset the input field to 0
                coinUsed = 0;
                return;
            }
            if (coinUsed > totalAmount) {
                showToast("Bạn không thể sử dụng coins để giảm giá đơn hàng xuống dưới 0đ!", false);
                $("#coinsUsed").val(0); // reset the input field to 0
                coinUsed = 0;
                return;
            }
            totalAmount -= coinUsed;
            myCoins -= coinUsed;
            $("#spanGiamGiaCoins").text(coinUsed.toLocaleString('en-US', { minimumFractionDigits: 0 }) + " đ");
            $("#totalAmount").text(totalAmount.toLocaleString('en-US', { minimumFractionDigits: 0 }) + " đ");
            $("#coins").text(myCoins.toLocaleString('en-US', { minimumFractionDigits: 0 }) + " xu");
            showToast("Đã áp dụng " + coinUsed + " coins", true);
        });
        $(document).on('change', '#moneyGiven', function () {
            var moneyGiven = parseInt($(this).val()); // Số tiền khách đưa

            if (isNaN(moneyGiven)) {
                alert("Vui lòng nhập một số hợp lệ!");
                $(this).val(totalAmount); // reset the input field to totalAmount
                return;
            }
            if (moneyGiven < 0) {
                alert("Số tiền không thể là số âm!");
                $(this).val(totalAmount); // reset the input field to totalAmount
                return;
            }
            if (moneyGiven < totalAmount) {
                alert("Số tiền bạn nhập không hợp lệ hoặc ít hơn tổng số tiền khách phải trả!");
                $(this).val(totalAmount); // reset the input field to totalAmount
                return;
            }
            var change = moneyGiven - totalAmount; // Tiền thừa trả khách
            $("h5.mb-0:contains('0đ')").text(change.toLocaleString('en-US') + " đ");
        });

        // xoá tab
        $(document).on('click', '.tab-close', function (event) {
            event.stopPropagation();
            const tabIndex = parseInt($(this).closest('.tab').text().replace('Đơn ', ''));
            const confirmDelete = confirm('Bạn có chắc chắn muốn xoá tab này không?');
            if (confirmDelete) {
                const currentTab = $(this).closest('.tab');
                const prevTab = currentTab.prev('.tab');
                var orderId = currentTab.data('orderId');
                $.ajax({
                    url: '/Admin/BanTaiQuay/RemovePendingOrder',
                    type: 'POST',
                    data: {
                        orderId: orderId
                    },
                    success: function (results) {

                    }
                });

                tabs = tabs.filter(index => index !== tabIndex);
                currentTab.remove();
                if (tabs.length > 0) {
                    if (prevTab.length > 0) {
                        setActiveTab(prevTab);
                    } else {
                        setActiveTab($('.tab:not(.tab-add)').first());
                    }
                    $("#orderIdInput").val($('.tab.active').data('orderId'));
                    loadDataUserOrder($("#orderIdInput").val());
                    updateTable();
                } else {
                    $('.tab-add').click();
                }
            }
        });

        function setActiveTab(tab) {
            $('.tab').removeClass('active');
            tab.addClass('active');

        }

        function RemoveOrderItem(id) {// id ở đây là productdetailid
            $.ajax({
                type: "POST",
                url: "/Admin/BanTaiQuay/RemoveOrderItem",
                data: {
                    productDetailId: id,
                    orderId: $("#orderIdInput").val(),
                },
                success: function (result) {
                    loadDataUserOrder($("#orderIdInput").val());
                    updateTable();
                },
                error: function (error) {
                    console.log(error);
                }
            });
        };
        function UpdateSL(id, newQuantity) { // id ở đây là productdetailid
            $.ajax({
                type: "POST",
                url: "/Admin/BanTaiQuay/UpdateQuantity",
                data: {
                    productDetailId: id,
                    orderId: $("#orderIdInput").val(),
                    newQuantity: newQuantity
                },
                success: function (result) {

                    showToast(result.message, result.isSuccess);
                    loadDataUserOrder($("#orderIdInput").val());
                    updateTable();
                },
                error: function (error) {
                    console.log(error);
                }
            });
        };
        updateTable();

        function updateTable() {
            var orderId = $("#orderIdInput").val();

            $.ajax({
                url: '/Admin/BanTaiQuay/GetOrderItems',
                type: 'POST',
                data: {
                    orderId: orderId
                },
                dataType: 'json',
                success: function (data) {
                    $('#pc-dt-simple tbody').empty(); // xoá tbody
                    if (data.length === 0) {
                        // Không có dữ liệu, hiển thị thông báo
                        $('#pc-dt-simple tbody').append('<tr><td colspan="5" class="text-center">Chưa có sản phẩm nào trong đơn hàng</td></tr>');
                    } else {
                        data.forEach(function (item) {
                            var row = $('<tr></tr>');

                            // Tạo ô đầu tiên với hình ảnh và tên sản phẩm
                            var cell1 = $('<td></td>');
                            var media = $('<div></div>').addClass('media align-items-center');
                            var img = $('<img>', { src: item.imageUrl, alt: 'image', class: 'bg-light wid-50 rounded' });
                            var mediaBody = $('<div></div>').addClass('media-body ms-3');
                            var h5 = $('<h5></h5>').addClass('mb-1').text(item.productName);
                            var p = $('<p></p>').addClass('text-sm text-muted mb-0').text("Kích cỡ: " + item.sizeName);
                            mediaBody.append(h5, p);
                            media.append(img, mediaBody);
                            cell1.append(media);
                            row.append(cell1);

                            // Tạo ô thứ hai với giá sản phẩm
                            var cell2 = $('<td></td>').addClass('text-end');
                            var h5Price = $('<h5></h5>').addClass('mb-0').text(item.price.toLocaleString("en-US", { minimumFractionDigits: 0 }) + " đ");
                            // var spanPrice = $('<span></span>').addClass('text-sm text-muted text-decoration-line-through').text('$129.99');
                            cell2.append(h5Price/* , spanPrice */);
                            row.append(cell2);

                            // Tạo ô thứ ba với nút tăng/giảm số lượng
                            var cell3 = $('<td></td>').addClass('text-center');
                            var divGroup = $('<div></div>').addClass('btn-group btn-group-sm mb-2 border').attr('role', 'group');
                            var btnMinus = $('<button></button>').attr('type', 'button').addClass('btn btn-link-secondary').html('<i class="ti ti-minus"></i>').on('click', function () {
                                // xử lí sự kiện click giảm số lượng
                                var newQuantity = item.quantity - 1;
                                if (newQuantity < 1) {
                                    return;
                                }
                                UpdateSL(item.id, newQuantity);
                            });
                            var inputNumber = $('<input>').addClass('wid-50 text-center border-0 m-0 form-control rounded-0 shadow-none').attr('type', 'text').attr('id', 'number').val(item.quantity).on('change', function () {
                                // Xử lý sự kiện onchange khi change số lượng
                                UpdateSL(item.id, $(this).val());
                                console.log('Số lượng đã thay đổi: ' + $(this).val());
                            });
                            var btnPlus = $('<button></button>').attr('type', 'button').addClass('btn btn-link-secondary').html('<i class="ti ti-plus"></i>').on('click', function () {
                                // xử lí sự kiện click tăng số lương
                                var newQuantity = item.quantity + 1;
                                UpdateSL(item.id, newQuantity);
                            });
                            divGroup.append(btnMinus, inputNumber, btnPlus);
                            cell3.append(divGroup);
                            row.append(cell3);

                            // Tạo ô thứ tư với tổng giá
                            var cell4 = $('<td></td>').addClass('text-end');
                            var h5Total = $('<h5></h5>').addClass('mb-0').text(item.total.toLocaleString("en-US", { minimumFractionDigits: 0 }) + " đ");
                            cell4.append(h5Total);
                            row.append(cell4);

                            // Tạo ô thứ năm với nút xóa
                            var cell5 = $('<td></td>').addClass('text-end');
                            var aDelete = $('<a></a>').attr('href', '#').addClass('avtar avtar-s btn-link-danger btn-pc-default').html('<i class="ti ti-trash f-18"></i>').on('click', function () {
                                RemoveOrderItem(item.id);
                                console.log('Nút xoá đã được nhấp!');
                            });
                            cell5.append(aDelete);
                            row.append(cell5);
                            $('#pc-dt-simple tbody').append(row);
                        });
                    }

                },
                error: function (error) {
                    console.log(error);
                }
            });
        };
        function loadDataUserOrder(orderId) {
            $("#checkOut").attr('disabled', false);
            $("#checkOut").text("Thanh toán");
            $("#checkOut").attr('hidden', false);
            $("#huyDon").text("Huỷ đơn");
            $("#huyDon").attr('hidden', false);
            $("#huyDon").attr('disabled', false);
            $("#moneyGiven").attr('readonly', false);
            $("#coinsUsed").attr('readonly', false);
            $("#discount-select").attr('disabled', false);
            $("#paymentType").attr('disabled', false);
            $.ajax({
                type: "GET",
                url: "/Admin/BanTaiQuay/loadDataUserOrder",
                data: {
                    orderId: orderId
                },
                success: function (result) {
                    totalAmount = result.total - voucherValue - coinUsed;
                    myCoins = result.coins;
                    total = result.total;
                    var xuTichDuoc = Math.round(total / 100);
                    if (result.orderStatus == 9) { // thanh toán thành công
                        $("#checkOut").attr('disabled', true);
                        $("#checkOut").text("Đã thanh toán");
                        $(".tab.active").css({
                            "background-color": "#1DE9B6",
                            "color": "white"
                        });
                        $("#huyDon").attr('hidden', true);
                        $("#huyDon").attr('disabled', true);
                        $("#moneyGiven").attr('readonly', true);
                        $("#coinsUsed").attr('readonly', true);
                        $("#discount-select").attr('disabled', true);
                        $("#paymentType").attr('disabled', true);

                    }
                    if (result.orderStatus == 13) {  // huỷ đơn
                        $("#checkOut").attr('disabled', true);
                        $("#checkOut").attr('hidden', true);
                        $(".tab.active").css({
                            "background-color": "#F0C2C3",
                            "color": "white"
                        });
                        $("#huyDon").attr('disabled', true);
                        $("#huyDon").text("Đơn hàng đã huỷ");
                        $("#moneyGiven").attr('readonly', true);
                        $("#coinsUsed").attr('readonly', true);
                        $("#discount-select").attr('disabled', true);
                        $("#paymentType").attr('disabled', true);
                    }
                    if (result.phoneNumber == "") {
                        xuTichDuoc = 0;
                    }
                    console.log(result)
                    $("#fullName").text(result.fullName);
                    $("#phoneNumber").text(result.phoneNumber);
                    $("#searchNumberPhone").val(result.phoneNumber);
                    $("#coins").text(result.coins.toLocaleString("en-US", { minimumFractionDigits: 0 }) + " xu");
                    $("#total").text(result.total.toLocaleString("en-US", { minimumFractionDigits: 0 }) + " đ");
                    $("#xuTichDuoc").text(xuTichDuoc.toLocaleString("en-US", { minimumFractionDigits: 0 }) + " xu");
                    $("#productQuantity").val(result.productQuantity).change();

                    $("#totalAmount").text(totalAmount.toLocaleString("en-US", { minimumFractionDigits: 0 }) + " đ");
                    $('#discount-select').empty();
                    $('#discount-select').append('<option value="">-- Chọn mã giảm giá --</option>');
                    // Thêm các option mới từ dữ liệu trả về
                    $.each(result.lstVoucher, function (index, item) {
                        $('#discount-select').append($('<option>', {
                            value: item.value,
                            text: item.text
                        }));
                    });
                },
                error: function (error) {
                    console.log(error);
                }
            });
        };
        $(document).on('change', '#productQuantity', function () {
            // Reset the voucher
            voucherId = "";
            voucherValue = 0;

            // Reset the coins used
            myCoins += coinUsed || 0; // return the coins used in the previous input
            coinUsed = 0;
            $("#coinsUsed").val(0); // reset the input field to 0

            // Recalculate the total amount
            totalAmount = total - coinUsed - voucherValue;

            // Update the display
            $("#discount-select").prop("selectedIndex", 0);
            $("#spanGiamGia").text(voucherValue.toLocaleString('en-US', { minimumFractionDigits: 0 }) + " đ");
            $("#totalAmount").text(totalAmount.toLocaleString('en-US', { minimumFractionDigits: 0 }) + " đ");
            $("#spanGiamGiaCoins").text(coinUsed.toLocaleString('en-US', { minimumFractionDigits: 0 }) + " đ");
        });

        function searchNumberPhone(term) {
            $.ajax({
                url: '/Admin/BanTaiQuay/GetPhoneNumbers',
                type: 'GET',
                success: function (data) {
                    var searchResultsElement = $('#searchNumberPhoneResults');
                    searchResultsElement.empty();

                    if (term.length > 0) {
                        var found = false;
                        data.forEach(function (result) {
                            // $.each(data, function (index, result) {
                            if (result.text.toLowerCase().includes(term.toLowerCase())) {
                                var resultElement = $('<li></li>').addClass('dropdown-item form-control');
                                var productItem = $('<div></div>').addClass('media-body ms-3');
                                var productName = $('<h5></h5>').addClass('mb-1').text(result.text);
                                // var pElement = $('<p></p>').addClass('text-sm text-muted mb-0').text('Tên KH: Trung ' );
                                // productName.append(pElement);
                                productItem.append(productName);
                                resultElement.append(productItem);
                                resultElement.on('click', function () {
                                    var orderId = $("#orderIdInput").val();
                                    $('#searchNumberPhone').val(result.text);
                                    searchResultsElement.hide();
                                    $.ajax({
                                        type: "POST",
                                        url: "/Admin/BanTaiQuay/AddUserToOrder",
                                        data: {
                                            userId: result.value,
                                            orderId: orderId
                                        },
                                        success: function (results) {
                                            console.log(results);
                                            loadDataUserOrder($("#orderIdInput").val());
                                            updateTable();
                                        },
                                        error: function (error) {
                                            console.log(error);
                                        }
                                    });
                                });

                                searchResultsElement.append(resultElement);
                                found = true;
                            }
                        });

                        if (!found) {
                            var notFoundElement = $('<li></li>').addClass('dropdown-item text-muted').text('Không tìm thấy khách hàng').css('text-align', 'center');
                            searchResultsElement.append(notFoundElement);
                        }

                        searchResultsElement.show();
                    } else {
                        searchResultsElement.hide();
                    }
                }
            });
        };


        function search(term) {
            $.ajax({
                url: '/Admin/BanTaiQuay/GetProductDetails',
                type: 'GET',
                success: function (results) {
                    var searchResultsElement = $('#searchResults');
                    searchResultsElement.empty();

                    if (term.length > 0) {
                        var found = false;
                        results.forEach(function (result) {
                            if (result.productName.toLowerCase().includes(term.toLowerCase())) {
                                var liElement = $('<li></li>').addClass('dropdown-item form-control').data('productDetailId', result.id);
                                var statusSp = "";
                                if (result.status) {
                                    statusSp = "đang bán";
                                } else {
                                    statusSp = "ngừng bán";
                                    liElement.css('background-color', '#F0B4B8');
                                }
                                var divMedia = $('<div></div>').addClass('media align-items-center');

                                var imgElement = $('<img>', {
                                    src: result.imageUrl,
                                    alt: 'image',
                                    class: 'bg-light wid-50 rounded'
                                });

                                var divMediaBody = $('<div></div>').addClass('media-body ms-3');

                                var h5Element = $('<h5></h5>').addClass('mb-1').text(result.productName);

                                var formattedPrice = result.price.toLocaleString("en-US", { minimumFractionDigits: 0 }) + " đ";
                                var pElement = $('<p></p>').addClass('text-sm text-muted mb-0').text('Kích cỡ: ' + result.sizeName + ' | Đơn giá: ' + formattedPrice + ' | Tồn kho: ' + result.quantity + ' | Trạng thái: ' + statusSp);

                                divMediaBody.append(h5Element, pElement);
                                divMedia.append(imgElement, divMediaBody);
                                liElement.append(divMedia);
                                liElement.on('click', function () {
                                    // Xử lý sự kiện click ở đây
                                    var productDetailId = $(this).data('productDetailId');
                                    var orderId = $("#orderIdInput").val();
                                    $.ajax({
                                        url: '/Admin/BanTaiQuay/AddProductDetailToOrder',
                                        type: 'POST',
                                        data: {
                                            productDetailId: productDetailId,
                                            orderId: orderId
                                        },
                                        success: function (results) {
                                            $("#searchInput").val("");
                                            $('#searchResults').hide();
                                            loadDataUserOrder($("#orderIdInput").val());
                                            updateTable();
                                            showToast(results.message, results.isSuccess);
                                        }
                                    });
                                });
                                searchResultsElement.append(liElement);
                                found = true;
                            }
                        });

                        if (!found) {
                            var notFoundElement = $('<li></li>').addClass('dropdown-item text-muted').text('Không tìm thấy sản phẩm').css('text-align', 'center');
                            searchResultsElement.append(notFoundElement);
                        }

                        searchResultsElement.show();
                    } else {
                        searchResultsElement.hide();
                    }
                }
            });
        };


        const video = $('#video')[0];
        let scanning = false;
        let scanner = new Instascan.Scanner({ video: video, refractoryPeriod: 1500 }); // set thời gian quét  mã qr giống nhau là 1.5s
        scanner.addListener('scan', function (content) {
            var productDetailId = content;
            var orderId = $("#orderIdInput").val();
            $.ajax({
                url: '/Admin/BanTaiQuay/AddProductDetailToOrder',
                type: 'POST',
                data: {
                    productDetailId: productDetailId,
                    orderId: orderId
                },
                success: function (results) {

                    loadDataUserOrder($("#orderIdInput").val());
                    updateTable();
                    showToast(results.message, results.isSuccess);
                }
            });
        });
        let cameras;
        $('#start').click(function () {
            if (!scanning) {
                Instascan.Camera.getCameras().then(function (availableCameras) {
                    cameras = availableCameras;
                    if (cameras.length > 0) {
                        var select = $('#cameraSelect');
                        select.empty();
                        $.each(cameras, function (i, camera) {
                            select.append($('<option/>', { value: camera.id, text: camera.name }));
                        });
                        $('#cameraModal').modal('show');
                        $('.modal-backdrop').remove();
                        $('body').removeClass('modal-open');
                    } else {
                        console.error('Không tìm thấy camera.');
                    }
                }).catch(function (e) {
                    alert('Error accessing camera: ' + e);
                });
            } else {
                stopScanning();
                video.hidden = true;
            }
        });
        $('#applyCamera').click(function () {
            var selectedCameraId = $('#cameraSelect').val();
            $('#cameraModal').modal('hide');
            video.play();
            video.hidden = false;
            scanning = true;
            var selectedCamera = $.grep(cameras, function (camera) { return camera.id === selectedCameraId; })[0];
            scanner.start(selectedCamera);
            showToast("Bật camera", true);
        });
        function stopScanning() {
            scanning = false;
            video.pause();
            showToast("Tắt camera", true);
            if (video.srcObject) {
                $.each(video.srcObject.getTracks(), function (i, track) {
                    track.stop();
                });
            }
        }
    });



</script>

