@model IEnumerable<FourLeafCloverShoe.Share.Models.OrderItem>
@{
    ViewData["Title"] = "OrderDetail";

}
<link rel="stylesheet" href="~/fileadmin/Orderdetail.css">
<script>
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }
</script>

<div class="container-fluid">
    <div class="header">
        <h2>Chi tiết đơn hàng</h2>
    </div>
    <div class="tabs">
        <button class="tablinks active" onclick="openTab(event, 'thongtin')">Thông tin</button>
        <button class="tablinks" onclick="openTab(event, 'giaohang')">Thông tin giao hàng</button>
        <button class="tablinks" onclick="openTab(event, 'lichsudiem')">Lịch sử điểm</button>
    </div>
    <div id="thongtin" class="tab-content" style="display: block;">
        <div class="details">
            <div class="details-left">
                <p>Mã hóa đơn: <span>@Model.FirstOrDefault().Orders.OrderCode</span></p> 
                <p>Ngày tạo: <span>@Model.FirstOrDefault().Orders.CreateDate</span></p>
                <p>Ngày thanh toán: <span>@Model.FirstOrDefault().Orders.PaymentDate</span></p>
                <p>Phương thức thanh toán: <span>@Model.FirstOrDefault().Orders.PaymentType</span></p>
                <p>Khách hàng: @Model.FirstOrDefault().Orders.RecipientName</p>
                <p>Nhân viên: <span></span></p>
            </div>
            <div class="details-right note">
                <label for="note">Ghi chú:</label>
                <textarea id="note"></textarea>
            </div>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>Mã hàng</th>
                    <th>Mặt hàng</th>
                    <th>Số lượng</th>
                    <th>Đơn giá</th>
                    <th>Thành tiền</th>
                </tr>
            </thead>
            <tbody>
               @foreach(var item in Model)
               {
                    <tr>
                        <td>@item.ProductDetails.SKU</td>
                        <td>@item.ProductDetails.Products.ProductName<span> - @item.ProductDetails.Size.Name - @item.ProductDetails.Colors.ColorName</span></td>
                        <td>@item.Quantity</td>
                        <td>@item.Price?.ToString("N0")</td>
                       
                        @{
                            var tt = item.Quantity * item.ProductDetails.PriceSale;
                        }
                        <td>@tt?.ToString("N0")</td>
                    </tr>
                 
                }
                
                
            </tbody>
        </table>
        <div class="details">
            <div class="details-right">
                <h6>
                    Tổng số lượng: <span>
                        @{
                            var tongcong = @Model.Sum(c => c.Quantity);
                                            <label class="col-sm-5 col-form-label">
                                                <b>
                                                    @tongcong?.ToString("n0")
                                                </b>
                                            </label>
                        }
                    </span>
                </h6>
                <h6>Tổng tiền hàng: <span></span></h6>
                <h6>Trừ tiêu điểm: <span>@Model.FirstOrDefault().Orders.CoinsUsed</span></h6>
                <h6>Trừ voucher: <span>@Model.FirstOrDefault().Orders.VoucherValue</span></h6>
                <h6>Phí vận chuyển: <span>@Model.FirstOrDefault().Orders.ShippingFee?.ToString("N0")</span></h6>
                <h6>Tổng cộng: <span>@Model.FirstOrDefault().Orders.TotalAmout?.ToString("N0")</span></h6>
            </div>
        </div>
    </div>
    <div id="giaohang" class="tab-content" style="display: none;">
        <p>Họ tên: @Model.FirstOrDefault().Orders.RecipientName</p>
        <p>Số điện thoại: @Model.FirstOrDefault().Orders.RecipientPhone</p>
        <p>Địa chỉ nhận hàng: @Model.FirstOrDefault().Orders.RecipientAddress</p>
        
    </div>
    <div id="lichsudiem" class="tab-content" style="display: none;">
        <p>Đơn này dùng: @Model.FirstOrDefault().Orders.CoinsUsed.Value.ToString("N0") xu</p>
        <p>Xu còn lại: @Model.FirstOrDefault().Orders.Users.Coins?.ToString("N0") xu</p>
    </div>
    <div class="d-flex flex-row justify-content-end">

        @if (@Model.FirstOrDefault().Orders.OrderStatus == -1)
        {
            <div class="d-flex p-2">
                <button type="button" class="btn btn-primary fw-normal text-white" onclick="DoiTrangThai('3')">Chờ Lấy Hàng</button>
            </div>
            <div class="d-flex p-2">
                <button type="button" class="btn btn-danger fw-normal text-white" @* onclick="huyDon('@Model.ID')" *@>Hủy bỏ</button>
            </div>
        }   @if (@Model.FirstOrDefault().Orders.OrderStatus == 0)
        {
            <div class="d-flex p-2">
                <button type="button" class="btn btn-primary fw-normal text-white" onclick="DoiTrangThai('1')">Chờ Thanh Toán</button>
            </div>
            <div class="d-flex p-2">
                <button type="button" class="btn btn-danger fw-normal text-white" @* onclick="huyDon('@Model.ID')" *@>Hủy bỏ</button>
            </div>
        }   @if (@Model.FirstOrDefault().Orders.OrderStatus == 1)
        {
            <div class="d-flex p-2">
                <button type="button" class="btn btn-primary fw-normal text-white" onclick="DoiTrangThai('3')">Chờ giao hàng</button>
            </div>
            <div class="d-flex p-2">
                <button type="button" class="btn btn-danger fw-normal text-white" @* onclick="huyDon('@Model.ID')" *@>Huỷ Đơn</button>
            </div>
        }   @if (@Model.FirstOrDefault().Orders.OrderStatus == 2)
        {
            <div class="d-flex p-2">
                <button type="button" class="btn btn-primary fw-normal text-white" onclick="DoiTrangThai('3')">Xác nhận đơn</button>
            </div>
            <div class="d-flex p-2">
                <button type="button" class="btn btn-danger fw-normal text-white" @* onclick="huyDon('@Model.ID')" *@>Hủy bỏ</button>
            </div>
        }
        @if (@Model.FirstOrDefault().Orders.OrderStatus == 3 )
            {
                <div class="d-flex p-2">
                <button type="button" class="btn btn-primary fw-normal text-white" onclick="DoiTrangThai('4')">Đang Giao Hàng</button>
                </div>
                <div class="d-flex p-2">
                    <button type="button" class="btn btn-danger fw-normal text-white" @* onclick="huyDon('@Model.ID')" *@>Hủy bỏ</button>
                </div>
        }
        @if (@Model.FirstOrDefault().Orders.OrderStatus == 4)
        {
            <div class="d-flex p-2">
                <button type="button" class="btn btn-primary fw-normal text-white" onclick="DoiTrangThai('8')">Giao Hàng Thành Công</button>
            </div>
            <div class="d-flex p-2">
                <button type="button" class="btn btn-primary fw-normal text-white" onclick="DoiTrangThai('6')">Giao Hàng Thất Bại</button>
            </div>
        }
        @if (@Model.FirstOrDefault().Orders.OrderStatus == 5)
        {
            <div class="d-flex p-2">
                <button type="button" class="btn btn-primary fw-normal text-white" onclick="DoiTrangThai('5')">Chờ lấy hàng</button>
            </div>
            <div class="d-flex p-2">
                <button type="button" class="btn btn-danger fw-normal text-white" @* onclick="huyDon('@Model.ID')" *@>Hủy bỏ</button>
            </div>
        }
        @if (@Model.FirstOrDefault().Orders.OrderStatus == 6)
        {
            <div class="d-flex p-2">
                <button type="button" class="btn btn-primary fw-normal text-white" onclick="DoiTrangThai('6')">Giao hàng thất bại</button>
            </div>
            <div class="d-flex p-2">
                <button type="button" class="btn btn-danger fw-normal text-white" @* onclick="huyDon('@Model.ID')" *@>Hoàn Hàng</button>
            </div>
        }
        @if (@Model.FirstOrDefault().Orders.OrderStatus == 8)
        {
            <div class="d-flex p-2">
                <button type="button" class="btn btn-primary fw-normal text-white" onclick="DoiTrangThai('8')">Giao hàng thành công</button>
           
             </div>
        } 
        @if (@Model.FirstOrDefault().Orders.OrderStatus == 9 )
            {
                <div class="d-flex p-2">
                        <button type="button" class="btn btn-primary fw-normal text-white" onclick="DoiTrangThai('9')">Thành Công</button>
                </div>
                <div class="d-flex p-2">
                    <button type="button" class="btn btn-danger fw-normal text-white" @* onclick="huyDon('@Model.ID')" *@>Hủy bỏ</button>
                </div>
        } 
        @if (@Model.FirstOrDefault().Orders.OrderStatus == 10)
        {
            <div class="d-flex p-2">
                        <button type="button" class="btn btn-primary fw-normal text-white" onclick="DoiTrangThai('10')">Yêu cầu đổi trả</button>
            </div>
        }

        <div class="d-flex p-2">
               <button type="button" class="btn btn-success">Lưu ghi chú</button>
        </div>
        <div class="d-flex p-2">
                 <button type="button" class="btn btn-secondary">In Hóa đơn</button>
        </div>
        <div class="d-flex p-2">
                 <button type="button" class="btn btn-dark">Xuất PDF</button>
        </div>
        <div class="d-flex p-2">
                 <button type="button" class="btn btn-danger">Huỷ đơn</button>
        </div>
    </div>
</div>



<script>
    function DoiTrangThai(trangthai) {
        var ans = confirm("Cập nhật trạng thái hóa đơn này?");
        var id = "@Model.FirstOrDefault().Orders.Id";
        console.log(id);
        console.log(trangthai);
        if (ans) {
            $.ajax({
                url: '@Url.Action("DoiTrangThai", "ManagerOrder")',
                type: "POST",
                data: {
                    idhd: id,
                    trangthai: trangthai,
                    
                },
                success: function (response) {
                    toastr.success(response.message, "Success Alert", { timeOut: 300 });
                    location.reload();
                },
                error: function (err) {
                    toastr.error('Thay đổi trạng thái thất bại', "Error Alert", { timeOut: 300 });
                }
            });
        }
    }
</script>

